!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Parser=t()}(this,function(){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function t(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}var o=function(){function s(e,t,r,n){i(this,s),this.type=e,this.value=t,this.raw_value=null===r?this.value:r,this.pos=n,this.errorStart=!1,this.errorStop=!1,this.unexpectedMessage="",this.afterSeparators="",this.cssClasses=["token",this.type],this.afterSeparatorsCssClasses=["token-spaces"],this.tokensList={Token_Empty_Str:"empty string",Token_Incomplete_Str:"incomplete string",Token_Error:"!",Token_Term:"filter",Token_String:"string",Token_Num:"numeric",Token_Facet_Separator:"':'",Token_Range:"'TO'",Token_Open_Backet:"'('",Token_Close_Bracket:"')'",Token_OR:"'OR'",Token_AND:"'AND'",Token_NOT:"'NOT'",Token_EOF:"end of filter",Token_Open_Angled_Bracket:"<",Token_Close_Angled_Bracket:">",Token_Coma:",",Token_Operator:"numeric operator",Term_Tag:"tag filter",Term_Numeric:"numeric filter",Term_Facet:"tag filter"}}return t(s,[{key:"toString",value:function(){return this.tokensList[this.type]}},{key:"tokenToString",value:function(e){return this.tokensList[e]}}]),s}(),s=function(){function e(){i(this,e),this.tokens=[],this.currentPos=0,this.lastToken=null}return t(e,[{key:"get",value:function(e){return void 0===e&&(e=0),this.currentPos+e>=this.tokens.length?this.tokens[this.tokens.length-1]:this.tokens[this.currentPos+e]}},{key:"next",value:function(){if(this.currentPos>this.tokens.length)return null;this.currentPos++}},{key:"isSeparator",value:function(e){return" "===e||"("===e||")"===e||"<"===e||">"===e||"="===e||"!"===e||":"===e||"'"===e||'"'===e}},{key:"readTokenValue",value:function(e,t){var r,n=!0,s=0;for(r=t;r<e.length&&!this.isSeparator(e[r]);r++)n=n&&("0"<=e[r]&&e[r]<="9"||r===t&&"-"===e[r]||t<r&&"."===e[r]&&1==++s);return r-t==2&&"O"===e[t+0]&&"R"===e[t+1]?new o("Token_OR",e.substr(t,r-t),null,t):r-t==2&&"T"===e[t+0]&&"O"===e[t+1]?new o("Token_Range",e.substr(t,r-t),null,t):r-t==3&&"N"===e[t+0]&&"O"===e[t+1]&&"T"===e[t+2]?new o("Token_NOT",e.substr(t,r-t),null,t):r-t==3&&"A"===e[t+0]&&"N"===e[t+1]&&"D"===e[t+2]?new o("Token_AND",e.substr(t,r-t),null,t):new o(n?"Token_Num":"Token_String",e.substr(t,r-t),null,t)}},{key:"readQuotedString",value:function(e,t){var r,n=e[t],s=!1;for(r=t+1;r<e.length;r++){if(e[r]===n&&!s)return r-t<=1?new o("Token_Empty_Str",n+n,null,r):new o("Token_String",e.substr(t+1,r-t-1),e.substr(t,r-t+1),t);s="\\"===e[r]&&!s}return new o("Token_Incomplete_Str",e.substr(t+1,r-t),e.substr(t,r-t),t)}},{key:"readToken",value:function(e,t){return"="===e[t]?new o("Token_Operator","=",null,t):"<"===e[t]?e.length>t+1&&"="===e[t+1]?new o("Token_Operator","<=",null,t):new o("Token_Open_Angled_Bracket","<",null,t):">"===e[t]?e.length>t+1&&"="===e[t+1]?new o("Token_Operator",">=",null,t):new o("Token_Close_Angled_Bracket",">",null,t):"!"===e[t]?e.length>t+1&&"="===e[t+1]?new o("Token_Operator","!=",null,t):new o("Token_Error",e[t],null,t):"("===e[t]?new o("Token_Open_Backet","(",null,t):")"===e[t]?new o("Token_Close_Bracket",")",null,t):":"===e[t]?new o("Token_Facet_Separator",":",null,t):","===e[t]?new o("Token_Coma",",",null,t):'"'===e[t]||"'"===e[t]?this.readQuotedString(e,t):this.readTokenValue(e,t)}},{key:"addToken",value:function(e){this.tokens.push(e),this.lastToken=e}},{key:"lex",value:function(e){var t=0;for(this.addToken(new o("First_Token","",null,0));t<e.length&&" "===e[t];)this.lastToken.afterSeparators+=e[t],t++;for(;t<e.length;){var r=this.readToken(e,t);if(this.addToken(r),"Token_Error"===r.type)return r.afterSeparators=e.substr(t+1,e.length-t),this.currentPos=this.tokens.length-1,!1;for(t+=r.raw_value.length;t<e.length&&" "===e[t];)this.lastToken.afterSeparators+=e[t],t++}return this.addToken(new o("Token_EOF","E",null,e.length)),!0}}]),e}();return function(){function e(){i(this,e)}return t(e,[{key:"parse",value:function(e){this.lexer=new s,this.termType="Term_None",this.firstTermToken=null,this.tags=[],this.numericsFilters=[],this.facetFilters=[],this.groups=[],this.foundAND=!1,this.foundOR=!1;var t={html:"",errorMessage:""};if(0===e.length)return t;!1===this.lexer.lex(e)&&(t.errorMessage="Not allowed "+this.lexer.get(0).toString()+" at col "+this.lexer.get(0).pos),this.lexer.next(),this.parseAnd()&&"Token_EOF"!==this.lexer.get().type&&this.unexpectedToken(this.lexer.get(),"Token_EOF");var r=!0;return t.tokens=this.lexer.tokens.map(function(e){return!e.errorStart&&r||(r=!1,e.cssClasses.push("unexpected")),e.errorStop&&(e.cssClasses.push("unexpected"),r=!0),r||e.afterSeparatorsCssClasses.push("unexpected"),e.unexpectedMessage&&(t.errorMessage=e.unexpectedMessage),t.html+='<span class="'.concat(e.cssClasses.join(" "),'">').concat(e.raw_value,'</span><span class="').concat(e.afterSeparatorsCssClasses.join(" "),'">').concat(e.afterSeparators,"</span>"),e}),t}},{key:"error",value:function(e,t){e.unexpectedMessage=t,e.errorStop=!0}},{key:"unexpectedToken",value:function(e,t){var r="Unexpected token "+e.toString();0<e.value.length&&("Token_String"===e.type||"Token_Num"===e.type)&&(r+="("+e.value.replace(/\n/g,"â†µ")+")"),r+=" expected "+e.tokenToString(t)+" at col "+e.pos,this.error(e,r)}},{key:"parseIntermediate",value:function(e){var t=this.termType;if(this.parseTerm()){for(;;){if(this.foundOR&&"Term_None"!==t&&this.termType!==t)return this.firstTermToken.errorStart=!0,this.error(this.lexer.get(-1),this.getSameOrError(t)),!1;if(t=this.termType,"Token_OR"!==this.lexer.get().type&&(!e||"Token_AND"!==this.lexer.get().type))break;if("Token_AND"===this.lexer.get().type?this.foundAND=!0:this.foundOR=!0,this.foundOR&&this.foundAND)return this.error(this.lexer.get(),"filter (X AND Y) OR Z is not allowed, only (X OR Y) AND Z is allowed"),!1;if(this.lexer.next(),!this.parseTerm())return!1}return!0}return!1}},{key:"parseAnd",value:function(){if(this.termType="Term_None",this.foundOR=!1,this.foundAND=!1,this.parseIntermediate(!1)){for(;;){if("Token_AND"!==this.lexer.get().type)break;if(this.lexer.next(),this.termType="Term_None",this.foundOR=!1,this.foundAND=!1,!this.parseIntermediate(!1))return!1}return!0}return!1}},{key:"getSameOrError",value:function(e){var t="Different types are not allowed in the same OR.";return"Term_Numeric"===e?(t+="\nExpected a numeric filter which needs to have one of the following form:",t+="\n - numeric_attr_name=10",t+="\n - numeric_attr_name>10",t+="\n - numeric_attr_name>=10",t+="\n - numeric_attr_name<10",t+="\n - numeric_attr_name<=10",t+="\n - numeric_attr_name!=10",t+="\n - numeric_attr_name:10 TO 20"):"Term_Facet"===e?(t+="\nExpected a facet filter which needs to have this form:",t+="\n - facet_name:facet_value"):"Term_Tag"===e&&(t+="\nExpected a tag filter which needs to have this form:",t+="\n - _tags:tag_value",t+="\n - tag_value"),t}},{key:"parseTerm",value:function(){if("Token_Open_Backet"===this.lexer.get().type)return this.lexer.next(),!!this.parseIntermediate(!0)&&("Token_Close_Bracket"!==this.lexer.get().type?(this.unexpectedToken(this.lexer.get(),"Token_Close_Bracket"),!1):(this.lexer.next(),!0));var e=!(this.termType="Term_None");if("Token_NOT"===this.lexer.get().type&&(this.lexer.next(),e=!0),"Token_String"!==this.lexer.get().type&&"Token_Num"!==this.lexer.get().type)return this.unexpectedToken(this.lexer.get(),"Token_Term"),!1;this.firstTermToken=this.lexer.get();var t=this.lexer.get();if(this.lexer.next(),"Token_Operator"===this.lexer.get().type||"Token_Open_Angled_Bracket"===this.lexer.get().type||"Token_Close_Angled_Bracket"===this.lexer.get().type){var r=this.lexer.get();if("Token_Open_Angled_Bracket"===this.lexer.get().type&&this.isOption(this.lexer.get(1)))return!!this.parseOptions(1)&&(this.tags.push(t.value+"<1>"),!0);if(this.lexer.next(),"Token_Num"!==this.lexer.get().type)return this.unexpectedToken(this.lexer.get(),"Token_Num"),!1;var n=this.lexer.get();return this.lexer.next(),this.termType="Term_Numeric",e&&this.negateOperator(r),this.numericsFilters.push(t.value+" "+r.value+" "+n.value),!0}if("Token_Facet_Separator"!==this.lexer.get().type)return e?this.tags.push("-"+t.value+"<1>"):"-"===t.value[0]||"\\"===t.value[0]?this.tags.push("\\"+t.value+"<1>"):this.tags.push(t.value+"<1>"),this.termType="Term_Tag",!0;if(this.lexer.next(),"Token_String"!==this.lexer.get().type&&"Token_Num"!==this.lexer.get().type)return this.unexpectedToken(this.lexer.get(),"Token_String"),!1;var s=this.lexer.get();if(this.lexer.next(),"Token_Num"===s.type&&"Token_Range"===this.lexer.get().type)return this.lexer.next(),"Token_Num"!==this.lexer.get().type?(this.unexpectedToken(this.lexer.get(),"Token_Num"),!1):(this.numericsFilters.push(t.value+":"+s.value+" TO "+this.lexer.get().value),this.lexer.next(),this.termType="Term_Numeric",!0);var i="_tags"===t.value;return this.termType=i?"Term_Tag":"Term_Facet",!!this.parseOptions(1)&&(e?i?this.tags.push("-"+s.value+"<1>"):this.facetFilters.push("-"+t.value+":"+s.value+"<1>"):"-"===s.value[0]||"\\"===s.value[0]?i?this.tags.push("\\"+s.value+"<1>"):this.facetFilters.push("\\"+t.value+":"+s.value+"<1>"):i?this.tags.push(s.value+"<1>"):this.facetFilters.push(t.value+":"+s.value+"<1>"),!0)}},{key:"parseOptions",value:function(e){if("Token_Open_Angled_Bracket"!==this.lexer.get().type)return!0;this.lexer.next();var t=!0;do{if(!this.parseOption(e))return!1;t=!1,"Token_Coma"===this.lexer.get().type&&(t=!0)}while(t);return"Token_Close_Angled_Bracket"!==this.lexer.get().type&&this.unexpectedToken(this.lexer.get(),"Token_Close_Angled_Bracket"),this.lexer.next(),!0}},{key:"parseOption",value:function(e){if("Token_String"!==this.lexer.get().type)return this.unexpectedToken(this.lexer.get(),"Token_String"),!1;var t=this.lexer.get();return this.lexer.next(),"score"===t.value?"Token_Operator"!==this.lexer.get().type||"="!==this.lexer.get().value?(this.unexpectedToken(this.lexer.get(),'\\"=\\"'),!1):(this.lexer.next(),"Token_Num"!==this.lexer.get().type?(this.unexpectedToken(this.lexer.get(),"Token_Num"),!1):(e=this.lexer.get().value,this.lexer.next(),e)):(this.unexpectedToken(t,'\\"score\\"'),!1)}},{key:"negateOperator",value:function(e){}},{key:"isOption",value:function(e){return"score"===e.value}}]),e}()});
